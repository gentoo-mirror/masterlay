From fde92386179104ec29b8d9fdc60ae9c6f6c76186 Mon Sep 17 00:00:00 2001
From: Grazvydas Ignotas <notasas@gmail.com>
Date: Sun, 17 Jul 2011 02:39:43 +0300
Subject: [PATCH 2/2] ntdll: Set restart_scan on first call to NtQueryDirectoryFile.

Fixes Portal2 crash.
---
 dlls/ntdll/directory.c       |    2 ++
 dlls/ntdll/tests/directory.c |   13 +++----------
 2 files changed, 5 insertions(+), 10 deletions(-)

diff --git a/dlls/ntdll/directory.c b/dlls/ntdll/directory.c
index 42b3639..11fe8e1 100644
--- a/dlls/ntdll/directory.c
+++ b/dlls/ntdll/directory.c
@@ -2004,6 +2004,8 @@ NTSTATUS WINAPI NtQueryDirectoryFile( HANDLE handle, HANDLE event,
         fstat( fd, &st );
         curdir.dev = st.st_dev;
         curdir.ino = st.st_ino;
+        if (lseek( fd, 0, SEEK_CUR ) == 0)
+            restart_scan = TRUE;
 #ifdef VFAT_IOCTL_READDIR_BOTH
         if ((read_directory_vfat( fd, io, buffer, length, single_entry,
                                   mask, restart_scan, info_class )) != -1) goto done;
-- 
1.7.0.4
